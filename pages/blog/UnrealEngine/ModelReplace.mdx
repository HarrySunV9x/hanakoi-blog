---
title: 模型替换
date: 2024-09-13
---

有两种方式可以获取游戏角色：

1. 创建角色蓝图，然后一步步往里加东西。
2. 拿到一个已有的角色，然后把他改成你想要的。

显然，除了一开始的学习或者研究。第二种方式从来都是最快的。

那么本篇文章，就将介绍第二种方式的实现过程：将东海帝皇替换为第三人称模板的小白人。

# 工具

本次教程环境：

- Blender 4.2
  - auto_rig_pro_3.72.26
  - add-on-mmd-tools-v4.2.2
- Unreal Engine 5.4

# 替换思路

一个角色有这么几个东西：

网格体：图形学渲染的本质就是一个个三角形组成的网格，网格组成模型的形状。然后将网格内的像素进行上色，就是组成模型。

骨骼：为了让角色动起来，我们就需要骨骼。骨骼是角色的动画支架，通过改变每个骨骼的位置和旋转角度来控制角色的姿态和动作。

蒙版：将骨骼与网格体绑定，通过绘制骨骼与网格体的权重，来定义当骨骼移动时，有哪部分网格也开始动，动多少幅度。

动画：是角色的动作序列，它是由一系列关键帧组成的，定义角色的动作。

游戏脚本：处理游戏角色的逻辑和交互行为，如移动、攻击、交互等。

Unreal 的组件设计与现代化代码的模块化思路有所不同，并非独立的模块，而是相互依赖的链条。比如，网格体依赖骨骼，单独修改网格体而不更新骨骼的关联是无法生效的。骨骼的命名必须与动画配置保持一致，才能正确匹配。而动画又需要和脚本同步，才能正确输出效果。因此，若要替换模型的外观，首先需要为模型适配相应的骨骼。

Unreal组件与传统代码的思路不太一样。比起模块，Unreal组件更像是一个链条。网格体会依赖骨骼，只修改网格体，没有骨骼的链接是不行的。骨骼名称要与动画配置一致才能正常对应。而动画又要和脚本一致，才能正确相应输出。我们想替换模型的外表，则要为模型适配对应的骨骼。

幸运的是，得益于 IK 重定向的存在，我们导入的模型骨骼不必与原模型完全相同，只需有相应的映射即可。人类模型的骨骼链条相似，意味着我们可以重新为模型适配骨骼，再通过 IK 重定向生成新的骨骼映射动画。动画配置保持不变，映射的骨骼虽不同，但不会影响脚本运行。

# 模型生成

在本教程中，我们将通过一套通用的配置替换新模型。为了通用，就不得不牺牲个性，因此我们会删除原有骨骼，重新生成一套通用人体骨骼以适配引擎中的模型。就像手机充电口一样，当有了type-c的规范后，无论什么手机，都可以通过同一个type-c的线充电了，而不需要对每一根充电线进行适配。

本文将使用模之屋中的赛马娘模型“东海帝皇”为例：https://www.aplaybox.com/details/model/ro7B1RYyWAUa

该模型相对简单，但与纯人体模型相比，还是有小裙子和马尾这种附加组件。**模型越复杂，处理蒙版的精度要求就越高**。对于初学者来说，手动处理蒙版是一项挑战，即使是经验丰富的老手，逐个调整骨骼去手动绘制蒙版也是一件繁琐的工作。好在我们已经有很强大的工具去完成绑定骨骼与绘制蒙版的工作了。

以下是具体的骨骼生成步骤：

1. **安装插件**

   打开 Blender，安装 `auto_rig_pro` 、 `mmd-tools` 和`voxel-heat-diffuse-skinning`插件。

   > mmd-tools：导入MMD的pmx格式的模型，二次元游戏官方发布的模型一般是这种格式，不支持直接导入游戏引擎。
   >
   > auto_rig_pro：快速绑定骨骼与自动绘制权重的工具，十分好用。
   >
   > voxel-heat-diffuse-skinning: auto_rig_pro 中可选择绘制权重的引擎有多种，其中voxel-heat-diffuse-skinning需要引入插件支持。是自测最好用的一种方式。

2. **导入模型**

   按 `N` 键打开侧边面板，选择 `mmd-tools` 插件。点击“导入”，并选择东海帝皇模型进行导入。

3. **分离材质**

   选中模型网格体，点击“按材质分开”。这样可以方便后续骨骼绑定。

4. **转换材质**

   将模型网格体转换为 Blender 材质，以确保导出的 `.fbx` 模型纹理正常应用。如果不点这个，导出的.fbx模型的纹理无法正常作用在网格体上，原理不清楚，具体表现为，导出的模型在引擎中是灰白膜，材质都是灰白色的。

5. **隐藏非身体部分**

   隐藏非身体部位的组件，仅保留身体部分用于骨骼绑定。例如东海帝皇的模型可以隐藏金属、尾巴和裙子，这是为了更好进行骨骼绑定，这些对于的部分会影响后续的绑定骨骼操作，一是有遮挡，二是影响识别。

6. **高亮模型**

   选中剩余的身体模型，确保其中任意一个位置高亮。

   > Blender有三种选中模式：普通选中，高亮选中与不选中。此处要使任意一个位置高亮，生成骨骼的按钮才会亮起。

7. **自动绑定骨骼**

   打开 `auto_rig_pro` 插件面板，展开 `Auto-Rig Pro: Smart` 选项，点击 `Get Selected Object`，选择 `Full Body`，并确认。

8. **骨骼定位**

   此时界面会转到模型的前视图。在auto_rig_pro的插件面板中，可以看到一个Add Neck按钮，此处是添加Neck骨骼的位置。点击后这里会变成Add Chin,代表选择下巴，添加后这里会继续改变……按以下顺序完成骨骼创建：

   - neck脖子：放在脖子底部拐弯处
   - chin下巴： 放在下巴尖
   - shoulder肩膀：放在咯吱窝上方
   - wrists手腕：放在手腕中间
   - spine root脊柱根：放在裤裆部位
   - ankles:脚踝：放在脚踝中间

   在放置时，要在前视图与侧视图都放准确。

9. **选择适配预设**

   在auto_rig_pro的插件面板中，选择 `Skeleton Setting presets`，设置为 `UE5 Manny-Quinn`（若使用 UE4，选择对应的 `UE4` 预设），可以更好的适配 UE5 小白人的模型。

10. **生成骨骼**

    在auto_rig_pro的插件面板中，点击go生成骨骼。

11. **手动校对骨骼**

    生成的骨骼可能不是很准确，检查并手动调整不准确的地方。

12. **完成骨骼匹配**

    点击 `Match to Rig` 完成骨骼的创建。

13. **处理蒙版**

    骨骼创建好以后，接下来是处理蒙版。点击视窗左上角的模式，切换至物品模式，选中皮肤和骨骼，并使骨骼高亮。

14. **绑定蒙版**

    在 `auto_rig_pro` 插件面板中，切换至蒙版模式，选择引擎，我推荐选择`voxel-heat-diffuse-skinning`。点击 `bind` 进行蒙版绑定。

15. **检查蒙版绘制**

    切换骨骼至编辑模式，移动骨骼，检查蒙版是否有绘制不合理的地方，手动进行调整。

16. **导出模型**

    点击 `文件 -> 导出 -> Auto-Rig Pro FBX (.fbx)`，选择 `Unreal Engine -> Humanold`，滑到最底部，勾选除 `UE4 legacy` 之外的所有选项（若使用 UE4，则勾选 `UE4 legacy`），点击导出模型。

# IK重定向

导出的FBX模型可以直接导入到Unreal Engine中。接下来，我们需要进行IK重定向。IK（Inverse Kinematics，反向运动学）重定向是动画和游戏开发中的一项重要技术，其主要作用是将导入的模型映射到现有的骨骼结构上，以便能够使用已有的动画和脚本。通过IK重定向，我们能够将导入的模型与Unreal Engine中的现有骨骼相匹配，使角色的动画和脚本得以正常使用。

可以用手机充电器来类比这个过程。每款手机都有各自的制造商，但如果想要让所有手机都能通过同一种充电线进行充电，就需要将充电接口统一为一个标准，比如USB Type-C。只要各个品牌的手机遵循Type-C的充电协议，就可以使用同一款充电器为不同的手机充电。

在这个类比中，充电器相当于角色的动作和动画，而我们要做的就是将角色的骨骼（充电接口）适配为统一标准。这样，无论模型如何不同，都可以使用相同的动画。

1. **生成模型的IK重定向**：为导入的模型建立骨骼链，确保每个关节的位置和旋转可以通过IK系统进行调整。
2. **生成小白人的IK重定向**：为小白人模型（通常是标准化的角色模型）建立骨骼链，确保其能够与其他模型共享动画。
3. **选中动画蓝图并重定向动画**：在动画蓝图中应用IK重定向，生成新的动画蓝图，以便将其与导入的模型和小白人模型连接。
4. **替换模型和动画蓝图**：将导入的模型与新的动画蓝图进行替换，确保一切都已正确配置。
5. **测试效果**：进入游戏，查看新的模型和动画效果是否正常运作。

通过这些步骤，我们可以确保IK重定向的过程顺利完成，并在游戏中实现所需的动画效果。



